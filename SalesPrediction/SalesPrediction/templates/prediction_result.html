{% extends "layout.html" %}
{% block title %}Prediction Result{% endblock %}
{% block header %}Prediction Result{% endblock %}

{% block content %}
<!-- Prediction Info Bar -->
<div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md border-l-4 border-[--theme-color]">
    <div class="grid grid-cols-2 md:grid-cols-5 gap-4 text-sm mt-2">
        <div><p class="text-gray-500 dark:text-gray-400 font-semibold">Dataset</p><p class="text-gray-700 dark:text-gray-300 truncate" title="{{ prediction.input_details }}">{{ prediction.input_details }}</p></div>
        <div><p class="text-gray-500 dark:text-gray-400 font-semibold">Sales Unit</p><p class="text-gray-700 dark:text-gray-300">{{ prediction.get('sales_unit', 'N/A') }}</p></div>
        <div><p class="text-gray-500 dark:text-gray-400 font-semibold">Item</p><p class="text-gray-700 dark:text-gray-300">{{ prediction.get('item_filtered', 'Overall') }}</p></div>
        <div><p class="text-gray-500 dark:text-gray-400 font-semibold">Frequency</p><p class="text-gray-700 dark:text-gray-300">{% if prediction.get('time_frequency') == 'W' %}Weekly{% elif prediction.get('time_frequency') == 'M' %}Monthly{% else %}Daily{% endif %}</p></div>
        <div><p class="text-gray-500 dark:text-gray-400 font-semibold">Forecast Horizon</p><p class="text-gray-700 dark:text-gray-300">{{ prediction.get('forecast_horizon', 'N/A') }} {% if prediction.get('time_frequency') == 'W' %}Weeks{% elif prediction.get('time_frequency') == 'M' %}Months{% else %}Days{% endif %}</p></div>
    </div>
</div>

<div class="max-w-7xl mx-auto bg-white dark:bg-gray-800 p-6 md:p-8 rounded-lg shadow-lg">
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-800 dark:text-white">{{ prediction.name or 'New Unsaved Prediction' }}</h2>
            {% if is_saved %}<p class="text-gray-500 dark:text-gray-400 text-sm">Created on: {{ prediction.date }}</p>{% endif %}
        </div>
        {% if not is_saved %}
        <button type="button" onclick="openSaveModal()" class="inline-flex items-center gap-x-2 rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 mt-4 md:mt-0"><i class="fas fa-save mr-2"></i> Save Prediction</button>
        {% else %}
        <div class="relative inline-block text-left mt-4 md:mt-0" x-data="{ open: false }">
            <div><button @click="open = !open" type="button" class="inline-flex w-full justify-center gap-x-1.5 rounded-md bg-white dark:bg-gray-700 px-3 py-2 text-sm font-semibold text-gray-900 dark:text-white shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-600"><i class="fas fa-download mr-2"></i>Export <svg class="-mr-1 h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" /></svg></button></div>
            <div x-show="open" @click.away="open = false" x-transition class="absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white dark:bg-gray-700 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" style="display: none;"><div class="py-1"><a href="#" onclick="event.preventDefault(); exportCSV('{{ doc_id }}')" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600"><i class="fas fa-file-csv mr-2 text-[--theme-color]"></i>Export as CSV</a><a href="#" onclick="event.preventDefault(); exportPDF('{{ doc_id }}')" class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-600"><i class="fas fa-file-pdf mr-2 text-red-500"></i>Export as PDF</a></div></div>
        </div>
        {% endif %}
    </div>
    
    <div class="mb-4 border-b border-gray-200 dark:border-gray-700"><nav class="-mb-px flex space-x-6" aria-label="Tabs"><button id="tab-xgboost" onclick="switchTab('xgboost')" class="flex items-center gap-x-2 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">XGBoost {% if prediction.get('recommended_model') == 'XGBoost' %}<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">Recommended</span>{% endif %}</button><button id="tab-arima" onclick="switchTab('arima')" class="flex items-center gap-x-2 whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm">ARIMA {% if prediction.get('recommended_model') == 'ARIMA' %}<span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded-full dark:bg-green-900 dark:text-green-300">Recommended</span>{% endif %}</button></nav></div>

    <!-- XGBoost Content -->
    <div id="content-xgboost">
        <!-- Insight Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-blue-800 dark:text-blue-300">Mean Absolute Error (MAE)</p><p class="text-2xl font-bold text-blue-900 dark:text-blue-200">{{ "%.2f"|format(prediction.xgboost_result.get('mae', 0)) }}</p></div>
            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-green-800 dark:text-green-300">R-squared (R²)</p><p class="text-2xl font-bold text-green-900 dark:text-green-200">{{ "%.2f"|format(prediction.xgboost_result.get('r2', 0)) }}</p></div>
            <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-purple-800 dark:text-purple-300">Total Forecasted Sales</p><p class="text-2xl font-bold text-purple-900 dark:text-purple-200">{% if prediction.get('sales_unit') == 'RM' %}RM {% endif %}{{ "%.2f"|format(prediction.xgboost_result.insights.get('total_forecast', 0)) }}</p></div>
            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-yellow-800 dark:text-yellow-300">Peak Sales Period</p><p class="text-2xl font-bold text-yellow-900 dark:text-yellow-200">{{ prediction.xgboost_result.insights.get('peak_period', 'N/A') }}</p></div>
        </div>
        <div class="lg:col-span-2 bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg"><canvas id="xgboostChart" style="height: 350px;"></canvas></div>
    </div>
    
    <!-- ARIMA Content -->
    <div id="content-arima" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-blue-800 dark:text-blue-300">Mean Absolute Error (MAE)</p><p class="text-2xl font-bold text-blue-900 dark:text-blue-200">{{ "%.2f"|format(prediction.arima_result.get('mae', 0)) }}</p></div>
            <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-green-800 dark:text-green-300">R-squared (R²)</p><p class="text-2xl font-bold text-green-900 dark:text-green-200">{{ "%.2f"|format(prediction.arima_result.get('r2', 0)) }}</p></div>
            <div class="bg-purple-50 dark:bg-purple-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-purple-800 dark:text-purple-300">Total Forecasted Sales</p><p class="text-2xl font-bold text-purple-900 dark:text-purple-200">{% if prediction.get('sales_unit') == 'RM' %}RM {% endif %}{{ "%.2f"|format(prediction.arima_result.insights.get('total_forecast', 0)) }}</p></div>
            <div class="bg-yellow-50 dark:bg-yellow-900/30 p-4 rounded-lg"><p class="text-sm font-medium text-yellow-800 dark:text-yellow-300">Peak Sales Period</p><p class="text-2xl font-bold text-yellow-900 dark:text-yellow-200">{{ prediction.arima_result.insights.get('peak_period', 'N/A') }}</p></div>
        </div>
        <div class="lg:col-span-2 bg-gray-50 dark:bg-gray-900/50 p-4 rounded-lg"><canvas id="arimaChart" style="height: 350px;"></canvas></div>
    </div>

    <!-- Inventory Planner -->
    <div class="mt-8 border-t dark:border-gray-700 pt-6">
        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4">Inventory Planner</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 dark:bg-gray-900/50 p-6 rounded-lg">
            <div>
                <label for="current_stock" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Enter Current Stock Level</label>
                <input type="number" id="current_stock" class="mt-1 block w-full rounded-md border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 shadow-sm focus:border-[--theme-color] focus:ring-[--theme-color]" placeholder="e.g., 500">
                <button onclick="getInventoryRecommendation()" class="mt-3 rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500">Get Recommendation</button>
            </div>
            <div id="recommendation-box" class="flex items-center justify-center p-4 bg-white dark:bg-gray-700 rounded-md min-h-[100px]">
                <p class="text-gray-500 dark:text-gray-400">Your recommendation will appear here.</p>
            </div>
        </div>
    </div>
</div>

<!-- Save Prediction Modal -->
<div id="saveModal" class="relative z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity"></div>
    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
      <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
        <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
          <form action="{{ url_for('save_prediction') }}" method="POST">
            <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4"><div class="sm:flex sm:items-start"><div class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-[--theme-color-faint] sm:mx-0 sm:h-10 sm:w-10"><i class="fas fa-edit text-[--theme-color]"></i></div><div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left"><h3 class="text-base font-semibold leading-6 text-gray-900 dark:text-white" id="modal-title">Save Prediction</h3><div class="mt-2"><p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Enter a name for this prediction to save it.</p><input type="text" name="prediction_name" required class="block w-full rounded-md border-0 py-1.5 bg-white dark:bg-gray-700 text-gray-900 dark:text-white shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-[--theme-color]" placeholder="e.g., 2025 Q3 Forecast"></div></div></div></div>
            <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6"><button type="submit" class="w-full justify-center rounded-md bg-[--theme-color] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-[--theme-color-dark] sm:ml-3 sm:w-auto">Save</button><button type="button" onclick="closeSaveModal()" class="mt-3 w-full justify-center rounded-md bg-white dark:bg-gray-600 dark:text-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-500 hover:bg-gray-50 dark:hover:bg-gray-500 sm:mt-0 sm:w-auto">Cancel</button></div>
          </form>
        </div>
      </div>
    </div>
</div>

<!-- Hidden form for PDF export -->
<form id="pdf-export-form" method="POST" class="hidden"><input type="hidden" name="chart_image" id="chart-image-input"></form>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
    const xgboostData = {{ prediction.xgboost_result.get('plot_data', {}) | tojson }};
    const arimaData = {{ prediction.arima_result.get('plot_data', {}) | tojson }};
    const timeFrequency = {{ prediction.get('time_frequency', 'W') | tojson }};
    const recommendedModel = {{ prediction.get('recommended_model', 'XGBoost') | tojson }};
    const isDarkMode = document.documentElement.classList.contains('dark');
    Chart.defaults.color = isDarkMode ? '#cbd5e1' : '#6b7280';
    let xgChart, arimaChart, chartRendered = false;

    function createChart(ctx, plotData, label) {
        const computedStyle = getComputedStyle(document.documentElement);
        const themeColor = computedStyle.getPropertyValue('--theme-color').trim();
        if (!plotData || !plotData.forecast_dates || plotData.forecast_dates.length === 0) {
             ctx.canvas.parentElement.innerHTML = `<div class="text-center text-red-500 p-10">Chart data missing or invalid. The model may have failed.</div>`;
            return null;
        }
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, `${themeColor}60`);
        gradient.addColorStop(1, `${themeColor}00`);

        return new Chart(ctx, { type: 'line', data: { labels: plotData.forecast_dates,
                datasets: [
                    { label: 'Forecast', data: plotData.forecast_values, borderColor: themeColor, backgroundColor: gradient, fill: 'origin', tension: 0.2 },
                    { label: 'Confidence Interval', data: plotData.lower_ci, fill: '+1', backgroundColor: 'rgba(150, 150, 150, 0.2)', borderColor: 'transparent', pointRadius: 0, tension: 0.2 },
                    { label: '_Confidence Interval', data: plotData.upper_ci, fill: false, borderColor: 'transparent', pointRadius: 0, tension: 0.2 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, animation: { onComplete: () => { chartRendered = true; }},
                scales: { x: { type: 'time', time: { unit: timeFrequency === 'W' ? 'week' : 'month' } }, y: { beginAtZero: true } },
                plugins: { legend: { labels: { filter: item => !item.text.includes('_Confidence') } } }
            }
        });
    }
    
    window.addEventListener('load', () => {
        xgChart = createChart(document.getElementById('xgboostChart').getContext('2d'), xgboostData, 'XGBoost Prediction');
        arimaChart = createChart(document.getElementById('arimaChart').getContext('2d'), arimaData, 'ARIMA Prediction');
        switchTab(recommendedModel.toLowerCase());
    });
    
    function switchTab(tab) {
        document.getElementById('content-xgboost').classList.toggle('hidden', tab !== 'xgboost');
        document.getElementById('content-arima').classList.toggle('hidden', tab !== 'arima');
        const xgTab = document.getElementById('tab-xgboost');
        const arimaTab = document.getElementById('tab-arima');
        
        const activeClasses = ['border-[--theme-color]', 'text-[--theme-color]', 'dark:text-[--theme-color-light]'];
        const inactiveClasses = ['border-transparent', 'text-gray-500', 'dark:text-gray-400', 'hover:text-gray-700', 'dark:hover:text-gray-300', 'hover:border-gray-300', 'dark:hover:border-gray-600'];
        
        xgTab.classList.remove(...(tab === 'xgboost' ? inactiveClasses : activeClasses));
        xgTab.classList.add(...(tab === 'xgboost' ? activeClasses : inactiveClasses));

        arimaTab.classList.remove(...(tab === 'arima' ? inactiveClasses : activeClasses));
        arimaTab.classList.add(...(tab === 'arima' ? activeClasses : inactiveClasses));
    }
    
    const saveModal = document.getElementById('saveModal');
    function openSaveModal() { saveModal.classList.remove('hidden'); }
    function closeSaveModal() { saveModal.classList.add('hidden'); }
    
    async function getInventoryRecommendation() {
        const stockInput = document.getElementById('current_stock');
        const recommendationBox = document.getElementById('recommendation-box');
        recommendationBox.innerHTML = `<p class="text-gray-500 dark:text-gray-400">Calculating...</p>`;
        
        let predictionData = (recommendedModel === 'XGBoost' ? xgboostData.forecast_values : arimaData.forecast_values);
        if (predictionData) {
            predictionData = predictionData.filter(v => v !== null);
        }

        const response = await fetch('/inventory_recommendation', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                current_stock: stockInput.value,
                prediction_data: predictionData
            })
        });
        const data = await response.json();
        recommendationBox.innerHTML = `<p class="text-indigo-800 dark:text-indigo-300 font-semibold text-center">${data.recommendation || data.error}</p>`;
    }
    
    function exportCSV(docId) { window.location.href = `/export_csv/${docId}`; }

    function exportPDF(docId) {
        if (!chartRendered) { alert('Please wait for the chart to finish rendering.'); return; }
        const activeChart = !document.getElementById('content-xgboost').classList.contains('hidden') ? xgChart : arimaChart;
        if (activeChart) {
            document.getElementById('chart-image-input').value = activeChart.toBase64Image();
            const form = document.getElementById('pdf-export-form');
            form.action = `/export_pdf/${docId}`;
            form.submit();
        } else {
            alert('Could not export PDF. The active chart is not available.');
        }
    }
</script>
{% endblock %}